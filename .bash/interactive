#!/bin/bash
#
# this is only sourced if we are interactive, but will be sourced before other stuff
# good place to put setup and environment stuff
#
[[ -f /etc/bash_completion && $_bash_completion_done != $$ ]] && . /etc/bash_completion
_bash_completion_done=$$

_completion_commands=( kubectl helm kustomize gcloud gh )

for c in ${_completion_commands[*]}
do
    complete | egrep -q -e "-F \w+ $c\$" && continue
    _c_cache=~/.bash/completion-$c
    [[ -s $_c_cache ]] || {
        $c completion $([[ $c == gh ]] && echo -s) bash 2>/dev/null > $_c_cache
    }
    source $_c_cache
    _completion_commands_done[$c]=1
done

kubectl &>/dev/null && {
    alias k=kubectl
    complete -o default -F __start_kubectl k
}


[[ -n $HOMEBREW_PREFIX && -r $HOMEBREW_PREFIX/etc/bash_completion ]] && \
    source $HOMEBREW_PREFIX/etc/bash_completion

# Environment setup
# #################
# I rule over all the other PATH bits
PrependPath $HOME/bin

# to avoid cm issues on centOS 5
export EDITOR=vim

#

# Aliases
# #######

alias grep='grep --color'                     # show differences in colour
#alias ls='ls -h --color=tty'                 # classify files in colour
alias mux=tmuxinator

# Functions
# #########

function settitle() { echo -n "^[]2;$*^G^[]1;$*^G"; }
function nwtb() {
    cd $(git worktree list | head -1 | cut -f1) || return 1
    git worktree add -b $1 $1 && {
        cd $1
        pre-commit install
        git push --set-upstream origin $1
    }
}

export SHELLCHECK_OPTS="-e SC2086 -e SC2046"

gofind() { # [dir] [test]
    local testarg
    testarg=true
    [[ -z $2 ]] && testarg='! -name "*_test.go"'

    find ${1:-.} \( -name "*.go" -a $testarg \) -print0
}

gogrep() {
    gofind $2 $3 | xargs -0 grep $4 -e "$1"
}

ygrep() { # grep in yaml
    grep -r ${2:.} --include "*.yaml" $3 -e "$1" 
}

function urldecode() {
    : "${*//+/ }"
    echo -e "${_//%/\\x}"
}
urlencode() {
    # urlencode <string>
    local length="${#1}"
    for (( i = 0; i < length; i++ )); do
        local c="${1:i:1}"
        case $c in
            [a-zA-Z0-9.~_-]) printf "$c" ;;
            *) printf '%%%02X' "'$c"
        esac
    done
}
