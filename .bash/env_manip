#!/bin/bash

# Environment manipulation functions

_VarRemove()
{
# VAR value - removes value from colon separated $VAR
# removes value from environment VAR if it is there
    [[ ${BASH_VERSINFO[0]} == 3 ]] && return
    local IFS current new
    IFS=:
    eval "current=(\$$1)"
    # add a # at end of each element
    current=("${current[@]/%/#}")
    # add a # at start of each element
    current=("${current[@]/#/#}")
    new=(${current[@]###$2#})
    # so now have #ele# #ele2# which we can remove with fear of
    # matching partials, but we did assume # isn't part of the var :-(
    unset IFS
    # strip the hashes
    new=(${new[@]//#})
    IFS=:
    eval "$1"="${new[*]}"
}

_VarAppend()
# VAR value, VAR=$VAR:$value equivalent
{
    local var=$1
    shift
    local i
    for i in "$@"
    do
	_VarRemove $var $i
        # shellcheck disable=SC1083
	eval export $var=\${$var:+\$$var\\:}$i
    done
}

_VarPrepend()
# VAR value, VAR=$value:$VAR equivalent
{
    local var=$1
    shift
    local i
    for i in "$@"
    do
	_VarRemove $var $i
        # shellcheck disable=SC1083
	eval export $var=$i\${$var:+\\:\$$var}
    done
}

PrependPath() { _VarPrepend PATH "$@"; }
AppendPath() { _VarAppend PATH "$@"; }

_remove_path_dupes()        # reads PATH and keeps order, but removes trailing dupes
{
    local IFS
    local -a patharray strippedpath newpath
    IFS=:
    patharray=($PATH)
    for p in "${patharray[@]}"
    do
        strippedpath=(${strippedpath[@]%%#$p})
        strippedpath+=("#$p")
    done
    unset IFS
    # shellcheck disable=SC2068
    newpath=$(printf "%s:" ${strippedpath[@]/##})
    PATH=${newpath/%:}
}
