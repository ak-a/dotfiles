#!bash


# Shell history stuff
shopt -s cmdhist
shopt -s histappend
shopt -s histreedit
shopt -s histverify

HISTCONTROL=ignoredups:ignorespace:erasedups
HISTSIZE=50000
HISTFILESIZE=10
HISTTIMEFORMAT="[%Y-%m-%dT%H:%M:%S] "

export HISTDIR=$HOME/.histdir
[ -d $HISTDIR ] || mkdir -p $HISTDIR

HISTFILESIZE=500000
HISTFILE=$HISTDIR/${HOSTNAME:-$(hostname -s)}.$(tty | cut -d/ -f4).$$
HISTFILEMERGE=$HOME/.bash_history_merged

# assumes a 'history -a' in prompt_command and
# needs a history -w $HISTFILEMERGE in .bash_logout
prompt_history() {
    local _histfile
    local _histfilepath
    history -a
    if [[ -z ${_HISTORYFIRSTRUN} ]]; then
        [[ -r $HISTFILEMERGE ]] && history -r $HISTFILEMERGE
        while read _histfile
        do
            _histfilepath=$HISTDIR/$_histfile
            if [[ $_histfilepath -nt $HISTFILEMERGE ]]; then
                history -r $_histfilepath
            else
                rm -f $_histfilepath
            fi
        done < <(ls -rt1 $HISTDIR)
        _HISTORYFIRSTRUN=true
    else
        history -n
    fi
}
