#!/bin/bash

if [ $(id -un) = root ]; then
    sudo -u andrew -- $0 "$@"
    chown -R andrew:plex /nas/media
fi

tty -s || exec >> /var/log/iplayer_pvr.log 2>&1

echo $0 STARTING: $(date)
echo "========================================"

get_iplayer_running() {
    pdir=$1
    pvr_lock=$pdir/pvr_lock
    # if we have a lock file then something might be running
    if [ -r $pvr_lock ]; then
	# check if the lock file corresponds to the iplayer
	# in particular the profile directory
        pgrep -f -F $pvr_lock $pdir && return 0
        # lock file is stale, remove and we say not running
        rm -f $pvr_lock
    fi
    return 1
}

# run iplayer pvr for each of the types...
# films no longer works, so stop wasting time for now
for type in radio tv # films 
do
    echo "$0: get_iplayer for $type $(date) --------------------"
    echo
    pdir=/home/get_iplayer/$type
    if get_iplayer_running $pdir; then
        echo "get_iplayer is running (pid=$(<$pdir/pvr_lock)), skipping"
	continue
    fi
    output=$(sed -n -e '/^output /s/^output //p' $pdir/options)
    [ -d "$output" ] || mkdir -p "$output"

    (
	cd $pdir || exit $?
        get_iplayer --profiledir . --refresh --refresh-future --cache-rebuild --refresh-limit 30
	set -x
	get_iplayer --profiledir . \
		    --hash \
		    --pvr \

    ) 2>&1
    echo "-------------------- get_iplayer done --------------"

    echo "Checking $output should be empty..."
    find "$output" -type f -print
    echo "Cleaning empty directories..."
    find "$output" -depth -mindepth 1 -type d -print -delete;
    echo; echo
done

# make sure we have the ownership right
find /nas/media -type f -print0 | xargs -0 chmod 0664
find /nas/media -type d -print0 | xargs -0 chmod 0775

echo $0 COMPLETED: $(date)
echo 
